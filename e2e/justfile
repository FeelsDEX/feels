#!/usr/bin/env just --justfile
# E2E Local Development Environment
# Run `just` to see all available commands

# Colors for output
GREEN := '\033[0;32m'
YELLOW := '\033[1;33m'  
RED := '\033[0;31m'
NC := '\033[0m'

# Default command - show help
default:
    @echo "E2E Development Commands"
    @echo "======================="
    @echo ""
    @echo "Core Commands:"
    @echo "  just run             - Start complete E2E environment"
    @echo "  just stop            - Stop all E2E services"
    @echo "  just status          - Check status of all services"
    @echo "  just logs [service]  - View logs (validator|streaming|indexer|app)"
    @echo ""
    @echo "Individual Components:"
    @echo "  just build-localnet  - Build with localnet feature"
    @echo "  just validator       - Start Solana validator only"
    @echo "  just deploy          - Deploy program to localnet"
    @echo "  just streaming       - Start streaming adapter only"
    @echo "  just indexer         - Start indexer only"
    @echo "  just app             - Start frontend app only"
    @echo ""
    @echo "Setup Commands:"
    @echo "  just setup-metaplex  - Deploy Metaplex Token Metadata"
    @echo "  just setup-tokens    - Setup JitoSOL and FeelsSOL"
    @echo "  just init-protocol   - Initialize Feels Protocol"

# Get Metaplex ID from config if available
metaplex-id := `jq -r '.programId // empty' ../feels-app/scripts/metaplex-localnet.json 2>/dev/null || echo ""`

# Program ID management
program-id := env_var_or_default("FEELS_PROGRAM_ID", "BLjLS7TzUBncLxXMjFYxezioeg4RVdc5vRpVRYDq8GyQ")

# Build with localnet feature if Metaplex is available
build-localnet:
    #!/usr/bin/env bash
    set -e
    cd ..
    
    # Check for Metaplex ID
    if [[ -n "{{metaplex-id}}" ]]; then
        echo "Using localnet Metaplex ID: {{metaplex-id}}"
        export METAPLEX_ID="{{metaplex-id}}"
    else
        echo "Warning: Metaplex config not found, using default"
    fi
    
    echo "Building Feels program with localnet feature..."
    
    # Try Nix build first
    if command -v just &> /dev/null; then
        RUSTFLAGS="--cfg feature=\"localnet\"" just build
    else
        RUSTFLAGS="--cfg feature=\"localnet\"" anchor build
    fi
    
    echo "{{GREEN}}✓ Build complete!{{NC}}"

# Build program (tries multiple strategies)
@_build:
    #!/usr/bin/env bash
    set -e
    cd ..
    
    BUILD_SUCCESS=false
    
    # Try localnet build if Metaplex is available
    if [[ -n "{{metaplex-id}}" ]] && [[ -f "e2e/build-localnet.sh" ]]; then
        echo "{{YELLOW}}Building with localnet feature...{{NC}}"
        if ./e2e/build-localnet.sh > logs/build.log 2>&1; then
            BUILD_SUCCESS=true
        fi
    fi
    
    # Try standard builds
    if [[ "$BUILD_SUCCESS" != "true" ]]; then
        if command -v just &> /dev/null; then
            echo "Building with just (Nix build)..."
            if just build > logs/build.log 2>&1; then
                BUILD_SUCCESS=true
            fi
        fi
    fi
    
    if [[ "$BUILD_SUCCESS" != "true" ]] && command -v anchor &> /dev/null; then
        echo "Building with anchor..."
        if RUSTFLAGS="-C opt-level=2 -C inline-threshold=0" anchor build --no-idl > logs/build.log 2>&1; then
            BUILD_SUCCESS=true
        fi
    fi
    
    if [[ "$BUILD_SUCCESS" != "true" ]]; then
        echo "{{RED}}Error: Build failed. Check logs/build.log{{NC}}"
        exit 1
    fi

# Start Solana validator
validator:
    #!/usr/bin/env bash
    cd ..
    mkdir -p logs
    
    echo "{{YELLOW}}Starting Solana validator...{{NC}}"
    solana-test-validator --reset --quiet > logs/validator.log 2>&1 &
    echo "Validator PID: $!"
    
    # Wait for validator
    echo "Waiting for validator to start..."
    while ! curl -s http://localhost:8899 >/dev/null 2>&1; do
        sleep 1
    done
    echo "{{GREEN}}✓ Validator ready{{NC}}"

# Deploy program to localnet
deploy: _build
    #!/usr/bin/env bash
    set -euo pipefail
    cd ..
    
    # Check for program keypair
    KEYPAIR_PATH="target/deploy/feels-keypair.json"
    if [[ ! -f "$KEYPAIR_PATH" ]]; then
        echo "{{YELLOW}}Generating program keypair...{{NC}}"
        mkdir -p target/deploy
        solana-keygen new -o "$KEYPAIR_PATH" --no-bip39-passphrase --force
    fi
    
    # Get program ID
    PROGRAM_ID=$(solana-keygen pubkey "$KEYPAIR_PATH")
    echo "Program ID: $PROGRAM_ID"
    
    # Update declare_id
    sed -i.bak "s/declare_id!(\"[^\"]*\")/declare_id!(\"$PROGRAM_ID\")/" programs/feels/src/lib.rs
    rm -f programs/feels/src/lib.rs.bak
    
    # Find program binary
    PROGRAM_SO=""
    for path in "target/deploy/feels.so" "target/sbf-solana-solana/release/feels.so"; do
        if [[ -f "$path" ]]; then
            PROGRAM_SO="$path"
            break
        fi
    done
    
    if [[ -z "$PROGRAM_SO" ]]; then
        echo "{{RED}}Error: Program binary not found{{NC}}"
        exit 1
    fi
    
    echo "{{YELLOW}}Deploying program...{{NC}}"
    solana program deploy "$PROGRAM_SO" --program-id "$KEYPAIR_PATH"
    echo "{{GREEN}}✓ Program deployed: $PROGRAM_ID{{NC}}"

# Generate IDL
idl-generate:
    #!/usr/bin/env bash
    cd ..
    echo "{{YELLOW}}Generating IDL...{{NC}}"
    
    if command -v just &> /dev/null; then
        just idl-build > logs/idl-build.log 2>&1
    else
        echo "{{RED}}Error: IDL generation requires Nix environment{{NC}}"
        exit 1
    fi
    
    # Copy to frontend
    if [[ -f "target/idl/feels.json" ]]; then
        mkdir -p feels-app/src/idl
        cp target/idl/feels.json feels-app/src/idl/
        
        # Fix IDL account names
        if [[ -f "feels-app/src/lib/fix-idl.js" ]]; then
            node feels-app/src/lib/fix-idl.js
            echo "{{GREEN}}✓ IDL generated and fixed{{NC}}"
        fi
    fi

# Setup Metaplex
setup-metaplex:
    #!/usr/bin/env bash
    cd ../feels-app
    if [[ -f "scripts/download-and-deploy-metaplex.sh" ]]; then
        ./scripts/download-and-deploy-metaplex.sh
    else
        echo "{{YELLOW}}Warning: Metaplex setup script not found{{NC}}"
    fi

# Setup tokens (JitoSOL and FeelsSOL)
setup-tokens:
    #!/usr/bin/env bash
    cd ../feels-app
    if [[ -f "scripts/setup-jitosol.js" ]]; then
        node scripts/setup-jitosol.js
    elif [[ -f "scripts/setup-jitosol.ts" ]]; then
        npx ts-node scripts/setup-jitosol.ts
    else
        echo "{{YELLOW}}Warning: Token setup script not found{{NC}}"
    fi

# Initialize protocol
init-protocol:
    #!/usr/bin/env bash
    cd ../feels-app
    if [[ -f "scripts/initialize-protocol.js" ]]; then
        export FEELS_PROGRAM_ID="{{program-id}}"
        node scripts/initialize-protocol.js
    else
        echo "{{YELLOW}}Warning: Protocol init script not found{{NC}}"
    fi

# Start streaming adapter
streaming:
    #!/usr/bin/env bash
    cd minimal-streaming-adapter
    
    echo "{{YELLOW}}Building streaming adapter...{{NC}}"
    cargo build --release 2>/dev/null
    
    echo "{{YELLOW}}Starting streaming adapter...{{NC}}"
    ./target/release/minimal-streaming-adapter \
        --rpc-url http://localhost:8899 \
        --port 10000 \
        --program-id "{{program-id}}" \
        > ../../logs/streaming-adapter.log 2>&1 &
    echo "Streaming adapter PID: $!"
    
    sleep 3
    echo "{{GREEN}}✓ Streaming adapter ready{{NC}}"

# Start indexer
indexer:
    #!/usr/bin/env bash
    cd ../feels-indexer
    
    echo "{{YELLOW}}Building indexer...{{NC}}"
    cargo build --release --bin feels-indexer-streaming 2>/dev/null
    
    echo "{{YELLOW}}Starting indexer...{{NC}}"
    ./target/release/feels-indexer-streaming \
        --streaming-endpoint http://localhost:10000 \
        --port 8080 \
        --program-id "{{program-id}}" \
        > ../logs/indexer.log 2>&1 &
    echo "Indexer PID: $!"
    
    # Wait for indexer
    while ! curl -s http://localhost:8080/health >/dev/null 2>&1; do
        sleep 1
    done
    echo "{{GREEN}}✓ Indexer ready{{NC}}"

# Start frontend app
app:
    #!/usr/bin/env bash
    cd ../feels-app
    
    # Create env file
    cat > .env.local <<EOF
    NEXT_PUBLIC_RPC_URL=http://localhost:8899
    NEXT_PUBLIC_INDEXER_URL=http://localhost:8080
    NEXT_PUBLIC_USE_INDEXER=true
    NEXT_PUBLIC_FEELS_PROGRAM_ID={{program-id}}
    EOF
    
    echo "{{YELLOW}}Starting frontend app...{{NC}}"
    npm run dev > ../logs/app.log 2>&1 &
    echo "App PID: $!"
    
    # Wait for app
    timeout=30
    while ! curl -s http://localhost:3000 >/dev/null 2>&1 && [ $timeout -gt 0 ]; do
        sleep 1
        ((timeout--))
    done
    
    if [ $timeout -gt 0 ]; then
        echo "{{GREEN}}✓ App ready at http://localhost:3000{{NC}}"
    else
        echo "{{YELLOW}}Warning: App startup timeout{{NC}}"
    fi

# Stop all services
stop:
    @echo "Stopping all E2E services..."
    @pkill -f solana-test-validator || true
    @pkill -f minimal-streaming-adapter || true
    @pkill -f feels-indexer-streaming || true
    @pkill -f "npm.*dev" || true
    @echo "All services stopped"

# Check status of all services
status:
    @echo "E2E Service Status"
    @echo "=================="
    @echo ""
    @echo -n "Solana Validator (8899):     "
    @curl -s http://localhost:8899 >/dev/null 2>&1 && echo "[RUNNING]" || echo "[NOT RUNNING]"
    @echo -n "Streaming Adapter (10000):   "
    @curl -s http://localhost:10000/status >/dev/null 2>&1 && echo "[RUNNING]" || echo "[NOT RUNNING]"
    @echo -n "Indexer API (8080):          "
    @curl -s http://localhost:8080/health >/dev/null 2>&1 && echo "[RUNNING]" || echo "[NOT RUNNING]"
    @echo -n "Application (3000):          "
    @curl -s http://localhost:3000 >/dev/null 2>&1 && echo "[RUNNING]" || echo "[NOT RUNNING]"

# View logs
logs SERVICE="all":
    #!/usr/bin/env bash
    cd ..
    case "{{SERVICE}}" in
        all)
            echo "Available log files:"
            ls -la logs/ 2>/dev/null || echo "No logs found"
            ;;
        validator)
            tail -f logs/validator.log 2>/dev/null || echo "No validator logs"
            ;;
        streaming|adapter)
            tail -f logs/streaming-adapter.log 2>/dev/null || echo "No streaming logs"
            ;;
        indexer)
            tail -f logs/indexer.log 2>/dev/null || echo "No indexer logs"
            ;;
        app)
            tail -f logs/app.log 2>/dev/null || echo "No app logs"
            ;;
        *)
            echo "Unknown service. Use: validator, streaming, indexer, or app"
            ;;
    esac

# Main E2E run command - starts everything
run: stop
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "Feels Protocol - Local E2E Development Environment"
    echo "=================================================="
    echo
    
    # Kill existing processes
    echo "Cleaning up existing processes..."
    just stop
    sleep 2
    
    cd ..
    mkdir -p logs
    
    # 1. Start validator
    just -f e2e/justfile validator
    
    # 2. Deploy program
    just -f e2e/justfile deploy
    
    # 3. Generate IDL
    just -f e2e/justfile idl-generate
    
    # 4. Setup Metaplex
    echo "{{YELLOW}}Setting up Metaplex...{{NC}}"
    just -f e2e/justfile setup-metaplex > logs/metaplex-setup.log 2>&1
    echo "{{GREEN}}✓ Metaplex deployed{{NC}}"
    
    # 5. Setup tokens
    echo "{{YELLOW}}Setting up tokens...{{NC}}"
    just -f e2e/justfile setup-tokens > logs/token-setup.log 2>&1
    echo "{{GREEN}}✓ Tokens setup complete{{NC}}"
    
    # 6. Initialize protocol
    echo "{{YELLOW}}Initializing protocol...{{NC}}"
    just -f e2e/justfile init-protocol > logs/protocol-init.log 2>&1
    echo "{{GREEN}}✓ Protocol initialized{{NC}}"
    
    # 7. Start streaming adapter
    just -f e2e/justfile streaming
    
    # 8. Start indexer
    just -f e2e/justfile indexer
    
    # 9. Start app
    just -f e2e/justfile app
    
    # Print summary
    echo ""
    echo "{{GREEN}}E2E Pipeline Running!{{NC}}"
    echo "========================"
    echo ""
    echo "Services:"
    echo "- Solana RPC: http://localhost:8899"
    echo "- Streaming SSE: http://localhost:10000/stream"
    echo "- Indexer API: http://localhost:8080"
    echo "- Frontend App: http://localhost:3000"
    echo ""
    echo "Commands:"
    echo "- just -f e2e/justfile status    - Check service status"
    echo "- just -f e2e/justfile logs      - View logs"
    echo "- just -f e2e/justfile stop      - Stop all services"
    echo ""
    echo "Press Ctrl+C to stop all services"
    
    # Keep running
    trap 'just -f e2e/justfile stop' EXIT
    wait

# Quick status check
check:
    @just status
    @echo ""
    @echo "To view logs: just logs [service]"