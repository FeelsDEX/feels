# Vanity Miner WASM Justfile
# Task runner for WASM module builds - uses Nix environment for tools

# Default recipe - show available commands
default:
    @just --list

# Check environment and fetch dependencies
install:
    #!/usr/bin/env bash
    
    # Check if we're in the correct Nix environment
    if ! command -v wasm-pack &> /dev/null; then
        echo "wasm-pack not found - entering Nix WASM environment..."
        cd .. && nix develop '.#wasm' --command bash -c "cd vanity-miner-wasm && just install"
        exit $?
    fi
    
    echo "Checking Nix environment and dependencies..."
    if ! command -v cargo &> /dev/null; then
        echo "ERROR: cargo not found. This should not happen in the Nix WASM environment."
        exit 1
    fi
    echo "Environment verified - Nix tools available"
    echo "Fetching Rust dependencies..."
    cargo fetch

# Build the WASM module with parallel support (production)
build:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Check if we're in the correct Nix environment
    if ! command -v wasm-pack &> /dev/null; then
        echo "wasm-pack not found - entering Nix WASM environment..."
        cd .. && nix develop '.#wasm' --command bash -c "cd vanity-miner-wasm && just build"
        exit $?
    fi
    
    wasm_out="../feels-app/public/wasm"
    echo "Building WASM module with parallel features..."
    rm -rf pkg
    mkdir -p "$wasm_out"
    
    # Build with wasm-pack using config from .cargo/config.toml
    # The config enables atomics, bulk-memory, and build-std automatically
    echo "  Using wasm-pack with nightly Rust (config from .cargo/config.toml)..."
    wasm-pack build --release --target web --out-dir pkg \
        --no-default-features --features parallel
    
    if [[ -f pkg/vanity_miner_wasm_bg.wasm ]]; then
        cp pkg/vanity_miner_wasm* "$wasm_out/"
        # Copy snippets directory if it exists (required for wasm-bindgen-rayon)
        if [[ -d pkg/snippets ]]; then
            cp -r pkg/snippets "$wasm_out/"
            echo "  Copied snippets directory for rayon support"
        fi
        echo ""
        echo "✓ Build complete and integrated into feels-app at $wasm_out"
        echo ""
        echo "Note: Multi-threading requires crossOriginIsolated context."
        echo "      Next.js dev server should set COOP/COEP headers automatically."
    else
        echo "WASM build failed - no output files found"
        exit 1
    fi

# Build for development (with debug info and panic hooks)
build-dev:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Check if we're in the correct Nix environment
    if ! command -v wasm-pack &> /dev/null; then
        echo "wasm-pack not found - entering Nix WASM environment..."
        cd .. && nix develop '.#wasm' --command bash -c "cd vanity-miner-wasm && just build-dev"
        exit $?
    fi
    
    wasm_out="../feels-app/public/wasm"
    echo "Building WASM module for development (with debug info)..."
    rm -rf pkg
    mkdir -p "$wasm_out"
    
    # Build with dev profile and panic hooks for better debugging
    wasm-pack build --dev --target web --out-dir pkg \
        --no-default-features --features "console_error_panic_hook parallel"
    
    if [[ -f pkg/vanity_miner_wasm_bg.wasm ]]; then
        cp pkg/vanity_miner_wasm* "$wasm_out/"
        # Copy snippets directory if it exists (required for wasm-bindgen-rayon)
        if [[ -d pkg/snippets ]]; then
            cp -r pkg/snippets "$wasm_out/"
            echo "  Copied snippets directory for rayon support"
        fi
        echo "✓ Development build copied to $wasm_out"
    else
        echo "WASM development build failed - no output files found"
        exit 1
    fi

# Clean build artifacts
clean:
    @echo "Cleaning build artifacts..."
    @rm -rf target target-rayon target-rayon-dev
    @rm -rf pkg
    @rm -rf ../feels-app/public/wasm/vanity_miner_wasm*
    @echo "Clean complete!"

# Run tests
test:
    #!/usr/bin/env bash
    
    # Check if we're in the correct Nix environment
    if ! command -v wasm-pack &> /dev/null; then
        echo "wasm-pack not found - entering Nix WASM environment..."
        cd .. && nix develop '.#wasm' --command bash -c "cd vanity-miner-wasm && just test"
        exit $?
    fi
    
    echo "Running WASM tests..."
    if command -v wasm-pack &> /dev/null; then
        echo "Using wasm-pack for testing..."
        wasm-pack test --headless --chrome
    elif [[ -f "test.html" ]] && [[ -d "pkg" ]]; then
        echo "Using local HTML test file..."
        echo "Opening test.html in browser for manual testing..."
        if command -v open &> /dev/null; then
            open test.html
        elif command -v xdg-open &> /dev/null; then
            xdg-open test.html
        else
            echo "test.html is available for manual testing"
            echo "Open the file in your browser to run tests"
        fi
        echo "Test file: $(pwd)/test.html"
    else
        echo "No test method available."
        echo "Available options:"
        echo "  1. Ensure you're in Nix environment: nix develop '.#wasm'"
        echo "  2. Run 'just build' to ensure WASM files are available"
        echo "  3. Use the frontend test pages: just test-pages"
        exit 1
    fi

# Build optimized and run benchmark
benchmark: build
    @echo "Opening benchmark page..."
    @open http://localhost:3000/test-benchmark.html

# Test WASM files are properly integrated (quick check)
test-integration:
    #!/usr/bin/env bash
    echo "Testing WASM integration..."
    wasm_dir="../feels-app/public/wasm"
    required_files=(
        "vanity_miner_wasm.js"
        "vanity_miner_wasm_bg.wasm"
        "vanity_miner_wasm.d.ts"
        "vanity_miner_wasm_bg.wasm.d.ts"
    )
    
    missing=0
    for file in "${required_files[@]}"; do
        if [[ -f "$wasm_dir/$file" ]]; then
            echo "[OK] $file"
        else
            echo "[MISSING] $file"
            ((missing++))
        fi
    done
    
    if [[ $missing -eq 0 ]]; then
        echo ""
        echo "All WASM files are properly integrated!"
        echo "Files located in: $wasm_dir/"
    else
        echo ""
        echo "WARNING: $missing file(s) missing. Run 'just build' to integrate WASM files."
        exit 1
    fi

# View the test pages
test-pages:
    @echo "Available test pages:"
    @echo "  - http://localhost:3000/test-coordinator.html (Multi-threaded mining test)"
    @echo "  - http://localhost:3000/test-benchmark.html (Performance benchmark)"
    @echo "  - http://localhost:3000/test-match-logic.html (Match logic verification)"
    @echo "  - file://$(pwd)/test.html (Local WASM test)"
