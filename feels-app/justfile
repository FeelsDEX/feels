# Frontend Application Commands
# Manages Next.js development, build, and deployment tasks

# Install Next.js app dependencies
install:
	@echo "Installing Next.js app dependencies..."
	npm install

# Start Next.js development server
dev:
	@echo "Starting Next.js development server..."
	@echo "App will be available at http://localhost:3000"
	npm run dev

# Start Next.js app with indexer integration
dev-indexer:
	@echo "Starting Next.js app with indexer integration..."
	@echo "App will connect to indexer at http://localhost:8080"
	npm run dev:indexer

# Build Next.js app for production
build:
	@echo "Building Next.js app for production..."
	npm run build

# Start production Next.js server
start: build
	@echo "Starting production Next.js server..."
	@echo "App will be available at http://localhost:3000"
	npm run start

# Lint the Next.js application
lint:
	@echo "Linting Next.js application..."
	npm run lint

# Type check the Next.js application
type-check:
	@echo "Type checking Next.js application..."
	npm run type-check

# Format the Next.js application code
format:
	@echo "Formatting Next.js application code..."
	npm run format

# Run Next.js app tests (placeholder - add when tests are implemented)
test:
	@echo "Running Next.js app tests..."
	@echo "Note: Tests not yet implemented. Add test scripts to package.json"
	npm run type-check

# Clean Next.js build artifacts
clean:
	@echo "Cleaning Next.js build artifacts..."
	rm -rf .next node_modules/.cache

# Full app setup: install dependencies
setup: install
	@echo "Next.js app setup complete!"
	@echo "Run 'just dev' to start the development server"

# Build app with fresh dependencies
fresh: clean install build
	@echo "Fresh Next.js app build complete!"

# Development workflow with indexer
dev-with-indexer: install
	@echo "Starting full development environment with indexer..."
	@echo "Make sure the indexer is running on http://localhost:8080"
	npm run dev:indexer

# Deploy Metaplex Token Metadata program to localnet
deploy-metaplex:
	#!/usr/bin/env bash
	set -euo pipefail
	
	echo "Checking for Metaplex Token Metadata program..."
	
	METAPLEX_PROGRAM_PATH="../target/external-programs/mpl_token_metadata.so"
	METAPLEX_PROGRAM_ID="HsYigmf9uvLS4QQkc7q9BkyvSf6mEVPxYyVf6rwwa8Bw"
	MAINNET_METAPLEX_ID="metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"
	CONFIG_FILE="scripts/metaplex-localnet.json"
	
	# Check if already downloaded
	if [[ -f "$METAPLEX_PROGRAM_PATH" ]]; then
	    echo "✓ Metaplex program already downloaded"
	else
	    echo "Downloading Metaplex Token Metadata program..."
	    mkdir -p ../target/external-programs
	    
	    # Download from mainnet
	    echo "Using solana CLI to dump the program from mainnet..."
	    if solana program dump $MAINNET_METAPLEX_ID $METAPLEX_PROGRAM_PATH --url mainnet-beta; then
	        echo "✓ Downloaded from mainnet"
	    else
	        echo "Failed to download Metaplex program"
	        exit 1
	    fi
	fi
	
	# Check if validator is running
	if ! curl -s http://localhost:8899 >/dev/null 2>&1; then
	    echo "Error: Local validator is not running"
	    echo "Please start the validator with: just validator"
	    exit 1
	fi
	
	# Check if metaplex keypair exists
	METAPLEX_KEYPAIR="../target/deploy/metaplex-keypair.json"
	if [[ ! -f "$METAPLEX_KEYPAIR" ]]; then
	    echo "Generating Metaplex keypair..."
	    solana-keygen new -o "$METAPLEX_KEYPAIR" --no-bip39-passphrase --force
	fi
	
	# Get the actual program ID from the keypair
	ACTUAL_METAPLEX_ID=$(solana-keygen pubkey "$METAPLEX_KEYPAIR")
	echo "Using Metaplex ID: $ACTUAL_METAPLEX_ID"
	
	# Deploy to localnet
	echo "Deploying Metaplex to localnet..."
	if solana program deploy --program-id $METAPLEX_KEYPAIR $METAPLEX_PROGRAM_PATH; then
	    echo "✓ Metaplex deployed successfully at $ACTUAL_METAPLEX_ID"
	    # Save configuration with actual ID
	    echo "{\"programId\": \"$ACTUAL_METAPLEX_ID\"}" > $CONFIG_FILE
	    echo "✓ Configuration saved to $CONFIG_FILE"
	else
	    echo "Failed to deploy Metaplex"
	    exit 1
	fi
