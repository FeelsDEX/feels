# Feels Protocol Test Suite Justfile
# This justfile provides commands for running the test suite with proper Nix environment

# Set the project root path for Nix flake
PROJECT_ROOT := "../../../"

# Show available test commands
help:
    @just --list --unsorted

# Run all tests
all:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running all tests                                                 ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels -- --test-threads=1
    @echo ""
    @echo "Note: This runs only in-memory tests. For devnet/localnet tests, use:"
    @echo "  - just devnet    # Run devnet tests"
    @echo "  - just localnet  # Run localnet tests"
    @echo "  - just test-all  # Run all tests including devnet/localnet"

# Run unit tests
unit:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running unit tests                                                ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels unit:: -- --test-threads=1

# Run integration tests
integration:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running integration tests                                         ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels integration:: -- --test-threads=1

# Run property-based tests
property:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running property-based tests                                      ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels property:: -- --test-threads=1

# Run end-to-end tests
e2e:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running end-to-end tests                                          ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels e2e:: -- --test-threads=1

# Run E2E pipeline tests (indexer + frontend integration)
e2e-pipeline:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║ Running E2E Pipeline Tests                                        ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo ""
    echo "Checking E2E services..."
    
    # Check services inline
    all_running=true
    
    if curl -s http://localhost:8899 >/dev/null 2>&1; then
        echo "[OK] Solana Validator: Running"
    else
        echo "[ERROR] Solana Validator: Not running"
        all_running=false
    fi
    
    if curl -s http://localhost:8080/health >/dev/null 2>&1; then
        echo "[OK] Indexer: Running"
    else
        echo "[ERROR] Indexer: Not running"
        all_running=false
    fi
    
    if curl -s http://localhost:3000 >/dev/null 2>&1; then
        echo "[OK] Frontend App: Running"
    else
        echo "[ERROR] Frontend App: Not running"
        all_running=false
    fi
    
    if curl -s http://localhost:10000/status >/dev/null 2>&1; then
        echo "[OK] Streaming Adapter: Running"
    else
        echo "[ERROR] Streaming Adapter: Not running"
        all_running=false
    fi
    
    if [ "$all_running" = false ]; then
        echo ""
        echo "[WARN] Not all services are running"
        echo "To start the full E2E environment: just -f ../../../e2e/justfile run"
        echo ""
    fi
    
    echo ""
    echo "Running pipeline tests..."
    just e2e-pipeline-indexer
    just e2e-pipeline-frontend
    @echo ""
    @echo "E2E Pipeline tests complete!"

# Run indexer pipeline tests
e2e-pipeline-indexer:
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Testing Indexer Data Pipeline"
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels test_indexer_placeholder -- --nocapture --test-threads=1
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Testing Indexer Analytics"
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    # Analytics test placeholder - to be implemented when indexer is running

# Run frontend DevBridge tests
e2e-pipeline-frontend:
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Testing Frontend DevBridge Integration"
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels test_devbridge_placeholder -- --nocapture --test-threads=1
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Testing Frontend Real-Time Updates"
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    # Real-time updates test placeholder - to be implemented
    @echo ""
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    @echo "Testing Frontend Error Handling"
    @echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    # Error handling test placeholder - to be implemented

# Run tests matching a pattern
filter PATTERN:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running tests matching: {{PATTERN}}                               ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels {{PATTERN}} -- --test-threads=1

# Run tests with verbose output
verbose CATEGORY="":
    @echo "Running tests with verbose output..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels {{CATEGORY}} -- --test-threads=1 --nocapture

# Run tests with multiple threads
parallel THREADS="4" CATEGORY="":
    @echo "Running tests with {{THREADS}} threads..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels {{CATEGORY}} -- --test-threads={{THREADS}}

# Run tests in release mode
release CATEGORY="":
    @echo "Running tests in release mode..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels {{CATEGORY}} --release -- --test-threads=1

# Run tests without capturing output
nocapture CATEGORY="":
    @echo "Running tests without output capture..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels {{CATEGORY}} -- --test-threads=1 --nocapture

# Run ignored tests
ignored:
    @echo "Running ignored tests..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels -- --test-threads=1 --ignored

# Run benchmarks
bench:
    @echo "Running benchmarks..."
    nix develop {{PROJECT_ROOT}} -c cargo bench -p feels

# Run tests with coverage (requires cargo-tarpaulin)
coverage:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running tests with coverage                                       ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop {{PROJECT_ROOT}} -c cargo tarpaulin -p feels --out Html --output-dir coverage

# Run tests that require localnet
localnet:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running localnet tests                                            ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @export ANCHOR_WALLET=keypairs/test-authority.json && \
        export ANCHOR_PROVIDER_URL=http://localhost:8899 && \
        export RUN_LOCALNET_TESTS=1 && \
        export DISABLE_AIRDROP_RATE_LIMIT=1 && \
        nix develop {{PROJECT_ROOT}} -c cargo test -p feels -- --test-threads=1 --nocapture --ignored

# Run tests that require devnet
devnet:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running devnet tests                                              ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @echo "Note: Rate limiting is enabled by default to prevent airdrop failures."
    @echo "Use 'just devnet-no-limit' to disable rate limiting."
    @export RUN_DEVNET_TESTS=1 && \
        nix develop {{PROJECT_ROOT}} -c cargo test -p feels -- --test-threads=1 --nocapture

# Run devnet tests without rate limiting
devnet-no-limit:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running devnet tests (no rate limit)                              ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @export RUN_DEVNET_TESTS=1 && \
        export DISABLE_AIRDROP_RATE_LIMIT=1 && \
        nix develop {{PROJECT_ROOT}} -c cargo test -p feels -- --test-threads=1 --nocapture

# Run ALL tests including in-memory, localnet, and devnet
test-all:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running ALL tests (in-memory + devnet + localnet)                ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @echo ""
    @echo "Step 1: Running in-memory tests..."
    @just all
    @echo ""
    @echo "Step 2: Running devnet tests..."
    @just devnet  
    @echo ""
    @echo "Step 3: Running localnet tests (requires local validator)..."
    @just localnet
    @echo ""
    @echo "All tests complete!"

# Watch tests and re-run on changes (requires cargo-watch)
watch CATEGORY="":
    @echo "Starting watch mode... (Press Ctrl+C to exit)"
    nix develop {{PROJECT_ROOT}} -c cargo watch -x "test -p feels {{CATEGORY}}"

# Run specific test file
file PATH:
    @echo "Running tests in {{PATH}}..."
    nix develop {{PROJECT_ROOT}} -c cargo test -p feels --test {{PATH}} -- --test-threads=1

# Clean test artifacts
clean-tests:
    @echo "Cleaning test artifacts..."
    rm -rf coverage/
    rm -rf test-results/

# Show test statistics
stats:
    @echo "Test statistics:"
    @echo "Unit tests:        $(find . -path "*/unit/*test_*.rs" | wc -l)"
    @echo "Integration tests: $(find . -path "*/integration/*test_*.rs" | wc -l)"
    @echo "Property tests:    $(find . -path "*/property/*test_*.rs" | wc -l)"
    @echo "E2E tests:         $(find . -path "*/e2e/*test_*.rs" | wc -l)"
    @echo "Total test files:  $(find . -name "test_*.rs" | wc -l)"
    @echo ""
    @echo "Test status:"
    @echo "In-memory tests:   279 passing"
    @echo "Devnet tests:      15 tests (requires RUN_DEVNET_TESTS=1)"
    @echo "Localnet tests:    Included in devnet count (requires local validator)"

# Alias for common commands
u: unit
i: integration
p: property
a: all