# Feels Protocol Test Suite Justfile
# This justfile provides commands for running the test suite with proper Nix environment

# Show available test commands
help:
    @just --list --unsorted

# Run all tests
all:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running all tests                                                 ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels -- --test-threads=1
    @echo ""
    @echo "Note: This runs only in-memory tests. For devnet/localnet tests, use:"
    @echo "  - just devnet    # Run devnet tests"
    @echo "  - just localnet  # Run localnet tests"
    @echo "  - just test-all  # Run all tests including devnet/localnet"

# Run unit tests
unit:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running unit tests                                                ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels unit:: -- --test-threads=1

# Run integration tests
integration:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running integration tests                                         ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels integration:: -- --test-threads=1

# Run property-based tests
property:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running property-based tests                                      ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels property:: -- --test-threads=1

# Run end-to-end tests
e2e:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running end-to-end tests                                          ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels e2e:: -- --test-threads=1

# Run tests matching a pattern
filter PATTERN:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running tests matching: {{PATTERN}}                               ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo test -p feels {{PATTERN}} -- --test-threads=1

# Run tests with verbose output
verbose CATEGORY="":
    @echo "Running tests with verbose output..."
    nix develop -c cargo test -p feels {{CATEGORY}} -- --test-threads=1 --nocapture

# Run tests with multiple threads
parallel THREADS="4" CATEGORY="":
    @echo "Running tests with {{THREADS}} threads..."
    nix develop -c cargo test -p feels {{CATEGORY}} -- --test-threads={{THREADS}}

# Run tests in release mode
release CATEGORY="":
    @echo "Running tests in release mode..."
    nix develop -c cargo test -p feels {{CATEGORY}} --release -- --test-threads=1

# Run tests without capturing output
nocapture CATEGORY="":
    @echo "Running tests without output capture..."
    nix develop -c cargo test -p feels {{CATEGORY}} -- --test-threads=1 --nocapture

# Run ignored tests
ignored:
    @echo "Running ignored tests..."
    nix develop -c cargo test -p feels -- --test-threads=1 --ignored

# Run benchmarks
bench:
    @echo "Running benchmarks..."
    nix develop -c cargo bench -p feels

# Run tests with coverage (requires cargo-tarpaulin)
coverage:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running tests with coverage                                       ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    nix develop -c cargo tarpaulin -p feels --out Html --output-dir coverage

# Run tests that require localnet
localnet:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running localnet tests                                            ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @export ANCHOR_WALLET=keypairs/test-authority.json && \
        export ANCHOR_PROVIDER_URL=http://localhost:8899 && \
        export RUN_LOCALNET_TESTS=1 && \
        export DISABLE_AIRDROP_RATE_LIMIT=1 && \
        nix develop -c cargo test -p feels -- --test-threads=1 --nocapture --ignored

# Run tests that require devnet
devnet:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running devnet tests                                              ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @echo "Note: Rate limiting is enabled by default to prevent airdrop failures."
    @echo "Use 'just devnet-no-limit' to disable rate limiting."
    @export RUN_DEVNET_TESTS=1 && \
        nix develop -c cargo test -p feels -- --test-threads=1 --nocapture

# Run devnet tests without rate limiting
devnet-no-limit:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running devnet tests (no rate limit)                              ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @export RUN_DEVNET_TESTS=1 && \
        export DISABLE_AIRDROP_RATE_LIMIT=1 && \
        nix develop -c cargo test -p feels -- --test-threads=1 --nocapture

# Run ALL tests including in-memory, localnet, and devnet
test-all:
    @echo "╔═══════════════════════════════════════════════════════════════════╗"
    @echo "║ Running ALL tests (in-memory + devnet + localnet)                ║"
    @echo "╚═══════════════════════════════════════════════════════════════════╝"
    @echo ""
    @echo "Step 1: Running in-memory tests..."
    @just all
    @echo ""
    @echo "Step 2: Running devnet tests..."
    @just devnet  
    @echo ""
    @echo "Step 3: Running localnet tests (requires local validator)..."
    @just localnet
    @echo ""
    @echo "All tests complete!"

# Watch tests and re-run on changes (requires cargo-watch)
watch CATEGORY="":
    @echo "Starting watch mode... (Press Ctrl+C to exit)"
    nix develop -c cargo watch -x "test -p feels {{CATEGORY}}"

# Run specific test file
file PATH:
    @echo "Running tests in {{PATH}}..."
    nix develop -c cargo test -p feels --test {{PATH}} -- --test-threads=1

# Clean test artifacts
clean-tests:
    @echo "Cleaning test artifacts..."
    rm -rf coverage/
    rm -rf test-results/

# Show test statistics
stats:
    @echo "Test statistics:"
    @echo "Unit tests:        $(find . -path "*/unit/*test_*.rs" | wc -l)"
    @echo "Integration tests: $(find . -path "*/integration/*test_*.rs" | wc -l)"
    @echo "Property tests:    $(find . -path "*/property/*test_*.rs" | wc -l)"
    @echo "E2E tests:         $(find . -path "*/e2e/*test_*.rs" | wc -l)"
    @echo "Total test files:  $(find . -name "test_*.rs" | wc -l)"
    @echo ""
    @echo "Test status:"
    @echo "In-memory tests:   279 passing"
    @echo "Devnet tests:      15 tests (requires RUN_DEVNET_TESTS=1)"
    @echo "Localnet tests:    Included in devnet count (requires local validator)"

# Alias for common commands
u: unit
i: integration
p: property
a: all